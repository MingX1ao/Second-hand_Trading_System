# 二手物品交易系统设计文档

## 一、用例模型

本系统有两个主要参与者：

* **普通用户**: 系统的基本使用者，可以注册、登录、发布和管理自己的物品。
* **管理员**: 拥有管理权限，负责系统的维护工作，如审批新用户和管理物品类别。

系统用例图如下

<center>
    <img src="IMG/yongli.png" width="400">
</center>

---

## 二、顺序图

### 2.1 新用户注册账户

```mermaid
sequenceDiagram
    participant Visitor as 访客
    participant LoginView as 登录界面
    participant RegWin as 注册窗口
    participant UM as UserManager
    participant DB as 数据库

    Visitor->>LoginView: 点击“注册”
    LoginView->>RegWin: 创建窗口
    activate RegWin

    Visitor->>RegWin: 填写信息 -> 点击“注册”
    Note right of RegWin: 验证：非空检查 & 密码一致性

    alt 验证失败
        RegWin-->>Visitor: 报错提示
    else 验证通过
        RegWin->>UM: register_user(...)
        activate UM
        Note right of UM: 生成 Salt & Hash
        UM->>DB: INSERT INTO users (status='pending'...)
        activate DB
        
        alt 用户名重复 (IntegrityError)
            DB-->>UM: 抛出错误
            deactivate DB
            UM-->>RegWin: 抛出错误信息
            RegWin-->>Visitor: 报错("用户名已存在")
        else 插入成功
            DB-->>UM: 成功
            UM-->>RegWin: 返回成功
            deactivate UM
            RegWin-->>Visitor: 提示("注册成功，请等待审批")
            RegWin->>RegWin: destroy()
        end
    end
    deactivate RegWin
```

---

### 2.2 用户登录系统

```mermaid
sequenceDiagram
    participant User as 用户
    participant App as 主程序(App)
    participant LoginView as 登录界面
    participant UM as UserManager
    participant DB as 数据库

    Note over App: 程序启动，显示登录界面
    User->>LoginView: 输入用户名、密码 -> 点击“登录”
    LoginView->>App: attempt_login(username, password)
    activate App

    App->>UM: get_user(username)
    activate UM
    UM->>DB: SELECT * FROM users...
    DB-->>UM: 返回用户数据
    deactivate UM

    alt 用户不存在
        App-->>User: 弹出错误框("用户不存在")
    else 用户存在
        App->>UM: authenticate(username, password)
        activate UM
        Note right of UM: 计算 Hash(输入密码 + Salt)<br/>与数据库 Hash 对比
        UM-->>App: 返回 User 对象 或 None
        deactivate UM

        alt 密码错误 (User is None)
            App-->>User: 弹出错误框("密码错误")
        else 验证通过
            alt 状态为待审核 (pending)
                App-->>User: 弹出警告("您的账户正在等待管理员审批")
            else 状态已批准 (approved)
                App->>App: current_user = user
                App->>App: show_main_view()
                App-->>User: 进入主界面
            end
        end
    end
    deactivate App
```

---

### 2.3 管理员管理用户

```mermaid
sequenceDiagram
    participant Admin as 管理员
    participant UserWin as 用户管理窗口
    participant UM as UserManager
    participant DB as 数据库

    Admin->>UserWin: 打开用户管理
    activate UserWin
    UserWin->>UM: get_all_users()
    UM->>DB: SELECT * FROM users
    DB-->>UM: 返回数据
    UM-->>UserWin: 返回用户列表
    UserWin-->>Admin: 展示列表 (Treeview)

    Admin->>UserWin: 选中"pending"用户 -> 点击"批准"
    UserWin->>UM: approve_user(username)
    activate UM
    UM->>DB: UPDATE users SET status='approved'...
    activate DB
    DB-->>UM: 成功
    deactivate DB
    UM-->>UserWin: 返回 True
    deactivate UM

    UserWin->>UserWin: refresh_users()
    UserWin-->>Admin: 提示"批准成功"
    deactivate UserWin
```

---

### 2.4 管理员管理类别

```mermaid
sequenceDiagram
    participant Admin as 管理员
    participant CatWin as 类别管理窗口
    participant CM as CategoryManager
    participant DB as 数据库

    Admin->>CatWin: 输入类别名称 & 属性列表
    Admin->>CatWin: 点击"保存"
    activate CatWin

    CatWin->>CM: get_all_categories()
    CM->>DB: SELECT
    DB-->>CM: 返回列表
    CM-->>CatWin: 返回类别名列表

    alt 类别已存在 (更新)
        CatWin->>CM: update_category(name, attributes)
        CM->>DB: UPDATE categories
    else 类别不存在 (新建)
        CatWin->>CM: add_category(name, attributes)
        CM->>DB: INSERT INTO categories
    end
    
    CatWin->>CatWin: refresh_list()
    CatWin-->>Admin: 提示操作成功
    deactivate CatWin
```

---

### 2.5 普通用户添加物品

```mermaid
sequenceDiagram
    participant Seller as 卖家
    participant InfoWin as 物品信息窗口
    participant CM as CategoryManager
    participant IM as ItemManager
    participant FS as 文件系统
    participant DB as 数据库

    Seller->>InfoWin: 打开窗口
    activate InfoWin
    Seller->>InfoWin: 选择"类别"
    InfoWin->>CM: get_attributes_for_category()
    CM-->>InfoWin: 返回属性模板
    InfoWin-->>Seller: 动态生成属性输入框

    Seller->>InfoWin: 填写信息 & 选择图片 -> 点击"保存"
    
    opt 上传了图片
        InfoWin->>FS: shutil.copy(src, target)
        FS-->>InfoWin: 返回新路径
    end

    InfoWin->>IM: create_item(...)
    activate IM
    IM->>DB: INSERT INTO items...
    activate DB
    DB-->>IM: 成功
    deactivate DB
    IM-->>InfoWin: 成功
    deactivate IM

    InfoWin-->>Seller: 提示"添加成功"
    InfoWin->>InfoWin: destroy()
    deactivate InfoWin
```

---

### 2.6 修改物品

```mermaid
sequenceDiagram
    participant User as 用户
    participant Main as 主界面
    participant InfoWin as 物品信息窗口
    participant IM as ItemManager
    participant DB as 数据库

    User->>Main: 选中物品 -> 点击"修改选中"
    activate Main
    Main->>IM: find_item_by_id(id)
    IM-->>Main: 返回 Item 对象

    Note right of Main: 判定1: 身份检查
    alt 非发布者 且 非管理员
        Main-->>User: 报错("只能修改自己的物品")
    else 身份验证通过
        Note right of Main: 判定2: 状态检查
        alt (已售出 或 有人想要) 且 非管理员
             Main-->>User: 报错("物品已锁定，无法修改")
        else 状态允许 或 管理员特权
             Main->>InfoWin: 打开窗口(传入 item)
             activate InfoWin
             InfoWin->>InfoWin: load_item_data()
             User->>InfoWin: 修改信息 -> 保存
             InfoWin->>IM: revise_item(id, data)
             IM->>DB: UPDATE items...
             InfoWin-->>User: 提示成功
             deactivate InfoWin
        end
    end
    deactivate Main
```

---

### 2.7 删除物品

```mermaid
sequenceDiagram
    participant User as 用户
    participant Main as 主界面
    participant IM as ItemManager
    participant DB as 数据库

    User->>Main: 选中物品 -> 点击"删除选中"
    activate Main
    
    Main->>User: 确认删除?
    User->>Main: 确认

    Main->>IM: find_item_by_id(id)
    IM-->>Main: 返回 Item 对象

    alt 非发布者 且 非管理员
        Main-->>User: 报错("无权删除")
    else 身份验证通过
        alt (已售出 或 有人想要) 且 非管理员
            Main-->>User: 报错("物品已锁定，无法删除")
        else 状态允许 或 管理员特权
            Main->>IM: delete_item(id)
            activate IM
            IM->>DB: DELETE FROM items...
            activate DB
            DB-->>IM: 成功
            deactivate DB
            deactivate IM
            Main->>Main: refresh_item_list()
        end
    end
    deactivate Main
```



---

### 2.8 搜索物品

```mermaid
sequenceDiagram
    participant User as 用户
    participant Main as 主界面
    participant IM as ItemManager
    participant DB as 数据库

    User->>Main: 选择类别(Category) -> 输入关键字 -> 点击"搜索"
    activate Main

    Main->>IM: search_items(category, keyword)
    activate IM
    IM->>DB: SELECT id FROM categories...
    IM->>DB: SELECT * FROM items WHERE category_id=... AND name LIKE ...
    activate DB
    DB-->>IM: 返回结果集
    deactivate DB
    IM-->>Main: 返回 Item 列表
    deactivate IM

    Main->>Main: 更新列表显示
    opt 结果为空
    Main-->>User: 提示("没有找到匹配物品")
    end
    deactivate Main
```



---

### 2.9 购买/发送意向

```mermaid
sequenceDiagram
    participant Buyer as 买家
    participant Main as 主界面
    participant IM as ItemManager
    participant DB as 数据库

    Buyer->>Main: 选中物品 -> 点击"购买"
    activate Main

    Main->>Main: 检查: 不能买自己的物品
    Main->>Main: 检查: 物品状态必须为 'active'

    alt 物品允许砍价 (can_bargain=1)
        Main-->>Buyer: 弹窗询问出价金额
        Buyer->>Main: 输入金额
    end

    Main-->>Buyer: 确认发送购买意向?
    Buyer->>Main: 确认 (Yes)

    Main->>IM: add_want(item_id, user_id, price)
    activate IM
    IM->>DB: INSERT INTO item_wants...
    activate DB
    
    alt 插入成功
        DB-->>IM: 成功
        IM-->>Main: True
        Main-->>Buyer: 提示("已发送购买意向")
    else 已经存在 (IntegrityError)
        DB-->>IM: 失败
        deactivate DB
        IM-->>Main: False
        deactivate IM
        Main-->>Buyer: 提示("您已经添加过意向了")
    end
    deactivate Main
```

---

### 2.10 确认出售

```mermaid
sequenceDiagram
    participant Seller as 卖家
    participant Main as 主界面
    participant SubWin as 买家选择窗口
    participant IM as ItemManager
    participant DB as 数据库

    Seller->>Main: 选中物品 -> 点击"确认出售"
    activate Main

    alt 物品已售出
        Main-->>Seller: 报错("物品已售出")
    else 物品在售
        Main->>IM: get_item_wanters(id)
        IM->>DB: JOIN查询 users & item_wants
        DB-->>IM: 返回列表
        IM-->>Main: 返回意向买家列表

        alt 列表为空
            Main-->>Seller: 提示("还没人想要")
        else 有人想要
            Main->>SubWin: 创建并显示(wanters)
            activate SubWin
            Seller->>SubWin: 选中买家 -> 点击"确认"
            SubWin->>Main: 回调(selected_buyer)
            SubWin->>SubWin: destroy()
            deactivate SubWin

            Main-->>Seller: 二次确认?
            Seller->>Main: 确认
            
            Main->>IM: confirm_sold(item_id, buyer_id)
            activate IM
            IM->>DB: UPDATE items SET status='sold', buyer_id=...
            DB-->>IM: 成功
            deactivate IM

            Main->>Main: refresh_item_list()
            Main-->>Seller: 提示("操作成功")
        end
    end
    deactivate Main
```

---

### 2.11 查看意向

```mermaid
sequenceDiagram
    participant User as 用户
    participant Main as 主界面
    participant WantsWin as 意向列表窗口
    participant IM as ItemManager
    participant DB as 数据库

    opt 查看"我的意向"
        User->>Main: 点击"我的意向"
        Main->>IM: get_user_wants(user_id)
        IM->>DB: JOIN查询 items, item_wants...
        DB-->>IM: 返回数据
        IM-->>Main: 返回列表
        Main->>WantsWin: 显示窗口(我的意向)
    end

    opt 查看"有人想要"
        User->>Main: 点击"有人想要"
        Main->>IM: get_received_wants(user_id)
        IM->>DB: JOIN查询 users, items...
        DB-->>IM: 返回数据
        IM-->>Main: 返回列表
        Main->>WantsWin: 显示窗口(收到的意向)
    end
```

---

## 三、类图

```mermaid
classDiagram
    %% --- Model Layer (数据实体) ---
    class User {
        +int id
        +str username
        +str role
        +str status
        +dict contact_info
        +address() str
        +phone() str
        +email() str
    }

    class Item {
        +int id
        +str name
        +str description
        +float price
        +str status
        +int can_bargain
        +dict specific_attributes
        +list image_paths
        +str owner_username
        +int want_count
    }

    class Category {
        +int id
        +str name
        +list attributes_template
    }

    class Message {
        +int id
        +int item_id
        +int sender_id
        +str content
        +int reply_to_id
        +datetime created_at
    }

    %% --- Controller Layer (业务逻辑) ---
    class UserManager {
        +authenticate(username, password) User
        +register_user(username, password, ...) bool
        +get_pending_users() List~User~
        +approve_user(username) bool
        +create_admin(username, password)
    }

    class ItemManager {
        +create_item(data)
        +get_all_items() List~Item~
        +search_items(category, keyword) List~Item~
        +revise_item(id, data)
        +delete_item(id)
        +add_want(item_id, user_id, offer)
        +confirm_sold(item_id, buyer_id)
        +add_message(item_id, sender_id, content)
    }

    class CategoryManager {
        +get_all_categories() List~str~
        +get_attributes_for_category(name) List~str~
        +add_category(name, attributes)
        +update_category(name, attributes)
        +delete_category(name)
    }

    %% --- View Layer (GUI 界面) ---
    class App {
        +UserManager user_manager
        +ItemManager item_manager
        +CategoryManager category_manager
        +User current_user
        +show_login_view()
        +show_main_view()
        +attempt_login()
        +logout()
    }

    class LoginView {
        +attempt_login()
        +open_register()
    }

    class RegisterWindow {
        +do_register()
    }

    class MainView {
        +refresh_item_list()
        +search_items()
        +open_add_item_window()
        +buy_item()
        +confirm_sold()
        +open_my_wants()
    }

    class ItemInfoWindow {
        <<Add/Edit Item>>
        +load_item_data()
        +on_category_change()
        +save_item()
    }

    class ItemDetailWindow {
        +refresh_messages()
        +send_message()
    }

    class UserManagementWindow {
        <<Admin Only>>
        +refresh_users()
        +approve_selected()
    }

    class CategoryManagementWindow {
        <<Admin Only>>
        +refresh_list()
        +save_category()
    }

    class BuyerSelectionWindow {
        +confirm()
    }

    %% --- Relationships (关系) ---
    
    %% App 组合了管理器 (Composition)
    App *-- UserManager
    App *-- ItemManager
    App *-- CategoryManager
    App o-- User : current_user

    %% App 管理视图切换
    App --> LoginView : creates
    App --> MainView : creates
    
    %% 视图依赖管理器和控制器
    LoginView ..> UserManager
    LoginView ..> App : calls attempt_login
    LoginView --> RegisterWindow : creates

    MainView ..> ItemManager
    MainView ..> CategoryManager
    MainView --> ItemInfoWindow : creates
    MainView --> ItemDetailWindow : creates
    MainView --> BuyerSelectionWindow : creates
    MainView --> UserManagementWindow : creates (if admin)
    MainView --> CategoryManagementWindow : creates (if admin)

    %% 管理器操作模型
    UserManager ..> User : returns/manages
    ItemManager ..> Item : returns/manages
    ItemManager ..> Message : returns/manages
    CategoryManager ..> Category : returns/manages

    %% 模型间的关联
    Item "0..n" --> "1" Category : belongs to
    Item "0..n" --> "1" User : owner
    Item "0..n" --> "0..1" User : buyer
    Message --> Item : attached to
    Message --> User : sender
```
